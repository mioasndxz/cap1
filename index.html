<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AR ì •ë¦¬ ë„ìš°ë¯¸ (ì •ì§€ ë¶„ì„ + í–¥ìƒ ê¸°ëŠ¥)</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 0; background: #f7f7f7; color: #333; }
    #video, canvas { display: block; margin: 0 auto; max-width: 100%; }
    .box { max-width: 640px; margin: 16px auto; padding: 16px; background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    button { padding: 10px 16px; margin: 8px 4px; font-size: 1em; background: #4a90e2; color: white; border: none; border-radius: 6px; cursor: pointer; }
    ul { list-style: none; padding-left: 0; }
    li { margin: 6px 0; }
    input[type="checkbox"] { margin-right: 8px; transform: scale(1.2); }
    .error { color: red; font-weight: bold; text-align: center; margin-top: 10px; }
    .scoreBox, .tipsBox, .spaceBox { margin-top: 8px; font-weight: bold; color: #444; }
  </style>
</head>
<body>

<video id="video" autoplay muted playsinline></video>
<canvas id="snapshotCanvas" width="640" height="480" style="display: none;"></canvas>
<div class="box">
  <button onclick="captureAndAnalyze('before')">ğŸ“¸ ì •ë¦¬ ì „ ë¶„ì„</button>
  <button onclick="captureAndAnalyze('after')">ğŸ“¸ ì •ë¦¬ í›„ ë¶„ì„</button>
</div>
<div class="box" id="resultBox">ì‚¬ì§„ì„ ì°ê³  ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
<div class="box scoreBox" id="scoreBox"></div>
<div class="box spaceBox" id="spaceBox"></div>
<div class="box tipsBox" id="tipsBox"></div>
<div class="box" id="checklistBox"></div>
<p class="error" id="errorMessage"></p>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
<script>
(async () => {
  await tf.setBackend('cpu');
  await tf.ready();
  console.log("âœ… TensorFlow ë°±ì—”ë“œ:", tf.getBackend());
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
<script>
const video = document.getElementById("video");
const canvas = document.getElementById("snapshotCanvas");
const ctx = canvas.getContext("2d");
const resultBox = document.getElementById("resultBox");
const checklistBox = document.getElementById("checklistBox");
const scoreBox = document.getElementById("scoreBox");
const tipsBox = document.getElementById("tipsBox");
const spaceBox = document.getElementById("spaceBox");
const errorMessage = document.getElementById("errorMessage");

const tipDictionary = {
  book: "ğŸ“š ì±…ì€ ì±…ê½‚ì´ì— ì •ë¦¬í•´ ì£¼ì„¸ìš”.",
  cup: "â˜• ì»µì€ ì”»ì–´ì„œ ì œìë¦¬ì— ë†“ìœ¼ì„¸ìš”.",
  bottle: "ğŸ§´ ë³‘ì€ ëšœê»‘ì„ ë‹«ì•„ ì •ë¦¬í•¨ì— ë„£ìœ¼ì„¸ìš”.",
  laptop: "ğŸ’» ë…¸íŠ¸ë¶ì€ ë‹«ì•„ì„œ ì •ëˆëœ ìœ„ì¹˜ì— ë†“ìœ¼ì„¸ìš”.",
  chair: "ğŸª‘ ì˜ìëŠ” ì±…ìƒ ì•„ë˜ë¡œ ë°€ì–´ ë„£ì–´ì£¼ì„¸ìš”."
};

const checklistDictionary = {
  book: ["ì±…ê½‚ì´ì— ë„£ê¸°"],
  cup: ["ì»µ ì”»ê¸°", "ê±´ì¡°ëŒ€ì— ë†“ê¸°"],
  bottle: ["ëšœê»‘ ë‹«ê¸°", "ì¬í™œìš©í•¨ì— ë„£ê¸°"],
  laptop: ["ë®ê°œ ë‹«ê¸°", "ì¶©ì „ê¸° ì •ë¦¬"],
  chair: ["ì •ìœ„ì¹˜ ì •ë ¬"]
};

const spaceGroups = {
  ì±…ìƒ: ["book", "laptop", "mouse", "keyboard"],
  ì£¼ë°©: ["cup", "bottle", "bowl"],
  ë°©: ["chair", "bed", "pillow"]
};

let cocoModel;
let beforeLabels = [];
let afterLabels = [];

function mapLabel(label) {
  return label.toLowerCase();
}

function guessSpace(labels) {
  const counts = {};
  for (const key in spaceGroups) {
    counts[key] = labels.filter(l => spaceGroups[key].includes(l)).length;
  }
  const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
  return sorted[0][1] > 0 ? sorted[0][0] : "ê¸°íƒ€";
}

function generateTips(labels) {
  const tips = [...new Set(labels.map(mapLabel))].map(l => tipDictionary[l]).filter(Boolean);
  return tips.length ? tips.join(" ") : "ì •ë¦¬ íŒ ì—†ìŒ";
}

function calculateScore(before, after) {
  const delta = before.length - after.length;
  let score = 50 + delta * 10;
  if (score > 100) score = 100;
  if (score < 0) score = 0;
  return `ğŸ§¹ ì •ë¦¬ ì ìˆ˜: ${score}ì  (ê°ì§€ ìˆ˜ ${before.length}ê°œ â†’ ${after.length}ê°œ)`;
}

function updateChecklist(labels) {
  let html = `<strong>ì²´í¬ë¦¬ìŠ¤íŠ¸:</strong><ul>`;
  [...new Set(labels.map(mapLabel))].forEach(label => {
    (checklistDictionary[label] || []).forEach(task => {
      html += `<li><input type="checkbox"> ${task}</li>`;
    });
  });
  html += '</ul>';
  checklistBox.innerHTML = html;
}

async function captureAndAnalyze(stage) {
  try {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const results = await cocoModel.detect(canvas);
    const labels = results.map(r => r.class);
    const lowerLabels = labels.map(mapLabel);

    if (stage === 'before') {
      beforeLabels = lowerLabels;
      resultBox.innerHTML = `ğŸ“Œ ì •ë¦¬ ì „ ê°ì§€ (${labels.length}ê°œ): ` + labels.join(', ');
      tipsBox.textContent = generateTips(lowerLabels);
      updateChecklist(lowerLabels);
      spaceBox.textContent = `ì˜ˆìƒ ê³µê°„: ${guessSpace(lowerLabels)}`;
      scoreBox.textContent = "";
    } else {
      afterLabels = lowerLabels;
      resultBox.innerHTML = `ğŸ“Œ ì •ë¦¬ í›„ ê°ì§€ (${labels.length}ê°œ): ` + labels.join(', ');
      const score = calculateScore(beforeLabels, afterLabels);
      scoreBox.textContent = score;
      tipsBox.textContent = generateTips(lowerLabels);
      checklistBox.innerHTML = "âœ”ï¸ ì •ë¦¬ í›„ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì™„ë£Œ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
      spaceBox.textContent = `ì˜ˆìƒ ê³µê°„: ${guessSpace(lowerLabels)}`;
    }
  } catch (e) {
    errorMessage.textContent = "â— ë¶„ì„ ì˜¤ë¥˜: " + e.message;
  }
}

(async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    await new Promise(res => video.onloadedmetadata = res);
    cocoModel = await cocoSsd.load();
  } catch (e) {
    errorMessage.textContent = "â— ì¹´ë©”ë¼ ì˜¤ë¥˜: " + e.message;
  }
})();
</script>

</body>
</html>
